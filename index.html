<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="./style.css">
  <base target="_top">
  <title>Factory Inventory — Mobile</title>
  <!-- QR library -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>3DPrintronics Inventory</h1>
      <div class="muted">Scan a QR or type the SKU, adjust quantity, and submit.</div>
    </div>

    <!-- Picker identity -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label for="pickerName">Employee Name</label>
          <select id="pickerName"></select>
        </div>
        <div class="col">
          <label for="location">Rack</label>
          <input id="location" value="MAIN" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button type="button" class="btn" id="btnScan">Scan Product QR</button>
      </div>
    </div>

    <!-- Product lookup -->
    <div class="card">
      <label for="sku">SKU</label>
      <div class="row sku-row" style="align-items:flex-end;">
        <input id="sku" placeholder="Enter SKU (exact)" />
        <button type="button" class="btn btn-light" id="btnFetch">Fetch</button>
      </div>

      <!-- Scanner UI -->
      <div id="scannerWrap">
        <div class="muted" style="margin:8px 0;">Point camera at QR (format: <code>SKU|VARIANT|LOCATION</code>).</div>
        <div id="reader"></div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button type="button" class="btn btn-light" id="btnStopScan">Stop camera</button>
          <button type="button" class="btn btn-outline" id="btnSwitchCam" style="display:none;">Switch camera</button>
        </div>
        <div id="scanStatus" class="status" style="display:none;" aria-live="polite"></div>
      </div>

      <div id="prodCard" style="display:none; margin-top:12px;">
        <!-- Top row: Name full width -->
        <div style="margin-bottom:10px;">
          <div class="pill" id="pName" style="display:block; font-weight:700; font-size:16px;"></div>
        </div>

        <!-- Second row: left = Loc/Current/Min, right = image placeholder -->
        <div class="row" style="align-items:stretch; gap:12px;">
          <div class="col">
            <div class="pill" id="pLoc">Loc: —</div>
            <div class="row" style="margin-top:8px; gap:10px;">
              <div class="col"><div class="pill">Current: <b id="pStock">—</b></div></div>
              <div class="col"><div class="pill">Min: <b id="pMin">—</b></div></div>
            </div>
          </div>
          <div class="col" style="flex:0 0 108px; max-width:108px;">
            <div id="pImgBox" style="width:100%; aspect-ratio:1; background:#eef1f6; border:1px solid #d6dbe2; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#666; font-size:12px;">
              Image
            </div>
          </div>
        </div>
      </div>

      <div id="fetchStatus" class="status" style="display:none;" aria-live="polite"></div>
    </div>

    <!-- Quantity + Reason -->
    <div class="card">
      <label for="qty">Quantity change</label>
      <div class="qty-wrap" style="margin:8px 0 14px;">
        <button type="button" class="qty-btn" id="decBtn" aria-label="Decrease quantity">−</button>
        <input id="qty" class="qty-input" type="number" value="0" step="1" inputmode="numeric" pattern="[0-9]*" min="0" />
        <button type="button" class="qty-btn" id="incBtn" aria-label="Increase quantity">+</button>
      </div>

      <div class="row">
        <div class="col">
          <label for="reason">Reason</label>
          <select id="reason">
            <option value="pick">Sales (–)</option>
            <option value="pack">Internal Use (–)</option>
            <option value="return">Re-Stock (+)</option>
            <option value="adjustUp">Adjust Up (+)</option>
            <option value="adjustDown">Adjust Down (–)</option>
          </select>
        </div>
        <div class="col">
          <label for="note">Note (optional)</label>
          <input id="note" placeholder="Order #123, etc." />
        </div>
      </div>

      <div id="stockPreview" class="muted" style="display:none; margin-top:8px;"></div>

      <div id="txStatus" class="status" style="display:none;" aria-live="polite"></div>

      <div class="row" style="margin-top:14px;">
        <button type="button" class="btn" id="submitBtn" disabled>Submit transaction</button>
      </div>
      <div class="muted" style="margin-top:8px;">Submit activates when picker name is filled, a product is fetched, and quantity ≠ 0.</div>
    </div>

    <div class="footer">3DPrintronics • v1</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { product: null, scanner: null, cameras: [], camIdx: 0 };
    // Replace with your Apps Script deployment /exec URL
    const APPS_SCRIPT_BASE = "https://script.google.com/macros/s/AKfycbw6AJvMkDqBeiPGGwh2rzq22Qj-76gSbSjA9gGzAhhKVW3lDMT_js7OD9Xhr2wTIZo9ag/exec";

    function setStatus(el, msg, kind) {
      el.style.display = msg ? 'block' : 'none';
      el.className = 'status ' + (kind || '');
      el.textContent = msg || '';
    }

    function setSubmitEnabled() {
      const pickerOk = !!$('pickerName').value.trim();
      const skuOk    = !!$('sku').value.trim();
      const qtyVal   = Number($('qty').value);
      const qtyOk    = Number.isFinite(qtyVal) && qtyVal !== 0;
      const reason   = $('reason').value;
      const noteTxt  = $('note').value.trim();
      const noteOk   = (reason === 'adjustUp' || reason === 'adjustDown') ? (noteTxt.length > 0) : true;
      const prodOk   = !!state.product;
      $('submitBtn').disabled = !(pickerOk && skuOk && qtyOk && noteOk && prodOk);
      updatePreview();
    }

    function focusSku() {
      const el = $('sku');
      if (el) { el.focus(); el.select && el.select(); }
    }

    function clearProductPanel() {
      $('pName').textContent  = '';
      $('pLoc').textContent   = '';
      $('pStock').textContent = '—';
      $('pMin').textContent   = '—';
      renderProductImage(null, null);
      $('prodCard').style.display = 'none';
      state.product = null;
    }

    function resetUIAfterSuccess(message) {
      // Show success toast
      setStatus($('txStatus'), message || 'Saved. Scan next item.', 'status-ok');
      setStatus($('fetchStatus'), '', '');
      setStatus($('scanStatus'),  '', '');

      // Clear transaction inputs
      $('sku').value = '';
      $('qty').value = '';
      $('reason').value = 'pick';
      $('note').value = '';

      // Clear product info and disable submit until refetch
      clearProductPanel();
      setSubmitEnabled();

      // Prefer scanner; fall back to focusing SKU if camera cannot start
      try {
        startScanner();
      } catch (e) {
        focusSku();
      }
    }

    function renderProductImage(url, name) {
      const box = $('pImgBox');
      if (!box) return;
      if (url && typeof url === 'string') {
        box.innerHTML = `<img src="${url}" alt="${(name || 'Product image').replace(/"/g,'') }" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:10px;" loading="lazy">`;
      } else {
        box.textContent = 'No image';
      }
    }

    // ---- Employees list fetch/cache
    async function loadEmployees() {
      try {
        // Check localStorage cache
        const cached = localStorage.getItem('employees_cache');
        const ts     = Number(localStorage.getItem('employees_cache_ts') || 0);
        const ageSec = (Date.now() - ts) / 1000;
        if (cached && ageSec < 86400) {
          populateEmployees(JSON.parse(cached));
          return;
        }

        const resp = await fetch(`${APPS_SCRIPT_BASE}?action=getEmployees`);
        if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
        const data = await resp.json();
        if (data && Array.isArray(data.names)) {
          localStorage.setItem('employees_cache', JSON.stringify(data.names));
          localStorage.setItem('employees_cache_ts', String(Date.now()));
          populateEmployees(data.names);
        }
      } catch (err) {
        console.error('Employee load failed', err);
      }
    }

    function populateEmployees(names) {
      const sel = $('pickerName');
      sel.innerHTML = '';
      const last = localStorage.getItem('employee_last');
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        if (last && last === n) opt.selected = true;
        sel.appendChild(opt);
      });
      // store last selection when changed
      sel.addEventListener('change', () => {
        localStorage.setItem('employee_last', sel.value);
        setSubmitEnabled();
      });
      setSubmitEnabled();
    }

    // ---- Product fetch via fetch()
    function fetchProduct() {
      setStatus($('fetchStatus'), 'Loading…', '');
      $('prodCard').style.display = 'none';
      renderProductImage(null, null);
      state.product = null;
      setSubmitEnabled();
      $('submitBtn').disabled = true;

      const sku = $('sku').value.trim();
      if (!sku) {
        setStatus($('fetchStatus'), 'Enter a SKU first.', 'status-err');
        return;
      }

      fetch(`${APPS_SCRIPT_BASE}?action=getProduct&sku=${encodeURIComponent(sku)}`)
        .then(r => r.ok ? r.json() : Promise.reject(`${r.status} ${r.statusText}`))
        .then((data) => {
          state.product = data;
          $('pName').textContent  = data.name ?? '';
          $('pLoc').textContent   = data.location ? `Loc: ${data.location}` : '';
          $('pStock').textContent = data.current_stock ?? '—';
          $('pMin').textContent   = data.min_stock ?? '—';
          renderProductImage(data.image_url, data.name);
          $('prodCard').style.display = 'block';
          setStatus($('fetchStatus'), 'Product loaded.', 'status-ok');
          setSubmitEnabled();
          updatePreview();
        })
        .catch((err) => {
          setStatus($('fetchStatus'), String(err), 'status-err');
          setSubmitEnabled();
        });
    }

    function nudgeQty(delta) {
      const cur = Number($('qty').value) || 0;
      $('qty').value = cur + delta;
      setSubmitEnabled();
    }

    function computeDeltaFromReason(qty, reason) {
      const q = Math.abs(Number(qty) || 0);
      if (!q) return 0;
      if (reason === 'pick' || reason === 'pack' || reason === 'adjustDown') return -q;
      if (reason === 'return' || reason === 'adjustUp') return +q;
      return 0;
    }

    function updatePreview() {
      const sp = $('stockPreview');
      if (!state.product) { sp.style.display = 'none'; sp.textContent=''; return; }
      const cur = Number(state.product.current_stock) || 0;
      const qty = Number($('qty').value) || 0;
      const reason = $('reason').value;
      const delta = computeDeltaFromReason(qty, reason);
      if (!delta) { sp.style.display = 'none'; sp.textContent=''; return; }
      const after = cur + delta;
      const dir = delta < 0 ? '↓' : '↑';
      sp.innerHTML = `Current: <b>${cur}</b> → After: <b>${after}</b> <span style="opacity:.8">(${dir} ${Math.abs(delta)})</span>`;
      sp.style.display = 'block';
    }

    function submitTx() {
      if (!state.product) return;

      const picker   = $('pickerName').value.trim();
      const sku      = $('sku').value.trim();
      const qty      = Number($('qty').value);
      const reason   = $('reason').value;
      const note     = $('note').value.trim();
      const location = $('location').value.trim() || 'MAIN';

      let qty_change = computeDeltaFromReason(qty, reason);

      if (!picker || !sku || !qty_change || qty_change === 0) return;

      setStatus($('txStatus'), 'Submitting…', '');
      $('submitBtn').disabled = true;

      const body = new URLSearchParams({
        user: picker,
        sku,
        location,
        qty_change: String(qty_change),
        reason,
        note
      });

      fetch(`${APPS_SCRIPT_BASE}?action=createTx`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      })
        .then(r => r.ok ? r.json() : Promise.reject(`${r.status} ${r.statusText}`))
        .then((data) => {
          if (data && data.ok) {
            // Clear/Reset UI to prevent accidental repeat on same SKU
            resetUIAfterSuccess(data.warning || 'Saved. Scan next item.');
          } else {
            setStatus($('txStatus'), (data && (data.error || data.details)) ? JSON.stringify(data).slice(0, 300) : 'Failed to save.', 'status-err');
          }
          $('submitBtn').disabled = true; // keep disabled until new fetch/scan
          setSubmitEnabled();
        })
        .catch((err) => {
          setStatus($('txStatus'), String(err), 'status-err');
          $('submitBtn').disabled = false;
          setSubmitEnabled();
        });
    }

    // ---- QR scanner
    async function startScanner() {
      if (!window.Html5Qrcode) {
        setStatus($('fetchStatus'), 'Scanner library not loaded. Check network.', 'status-err');
        return;
      }
      try {
        $('scannerWrap').style.display = 'block';
        setStatus($('scanStatus'), 'Opening camera…', '');
        // List cameras
        state.cameras = await Html5Qrcode.getCameras();
        $('btnSwitchCam').style.display = state.cameras.length > 1 ? 'inline-block' : 'none';
        // Prefer back camera by default on mobile
        const camId = { facingMode: "environment" };

        state.scanner = new Html5Qrcode('reader', { formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] });

        const config = { fps: 10, qrbox: { width: 240, height: 240 } };
        await state.scanner.start(camId, config, onScanSuccess, onScanError);
        setStatus($('scanStatus'), 'Camera ready. Point at the QR.', 'status-ok');
      } catch (err) {
        setStatus($('scanStatus'), 'Camera error: ' + String(err), 'status-err');
      }
    }

    function stopScanner() {
      if (state.scanner) {
        state.scanner.stop().then(() => {
          state.scanner.clear();
          state.scanner = null;
        }).catch(() => {});
      }
      $('scannerWrap').style.display = 'none';
      setStatus($('scanStatus'), '', '');
    }

    function switchCamera() {
      if (!state.cameras.length) return;
      state.camIdx = (state.camIdx + 1) % state.cameras.length;
      // Restart scanner with new camera
      if (state.scanner) {
        state.scanner.stop().then(() => {
          state.scanner.clear();
          state.scanner = null;
          startScanner();
        });
      }
    }

    // Called on successful QR read
    function onScanSuccess(decodedText) {
      // Expected format: sku|variant|location
      const parts = String(decodedText).split('|');
      const sku = (parts[0] || '').trim();
      const variant = (parts[1] || '').trim();
      const location = (parts[2] || '').trim();

      if (!sku) {
        setStatus($('scanStatus'), 'Invalid QR: missing SKU.', 'status-err');
        return;
      }

      $('sku').value = sku;
      if (location) $('location').value = location;

      // Stop camera and fetch
      stopScanner();
      fetchProduct();
    }

    function onScanError(err) {
      // We’ll keep it quiet; frequent scan errors are normal while searching.
    }

    // Wire up events
    window.addEventListener('DOMContentLoaded', () => {
      loadEmployees();
      $('btnFetch').addEventListener('click', fetchProduct);
      $('btnScan').addEventListener('click', startScanner);
      $('btnStopScan').addEventListener('click', stopScanner);
      $('btnSwitchCam').addEventListener('click', switchCamera);

      $('incBtn').addEventListener('click', () => nudgeQty(+1));
      $('decBtn').addEventListener('click', () => nudgeQty(-1));
      $('qty').addEventListener('input', setSubmitEnabled);
      // $('pickerName').addEventListener('input', setSubmitEnabled); // not needed, handled in populateEmployees
      $('sku').addEventListener('input', setSubmitEnabled);
      $('reason').addEventListener('change', setSubmitEnabled);
      $('note').addEventListener('input', setSubmitEnabled);
      $('submitBtn').addEventListener('click', submitTx);

      $('sku').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); fetchProduct(); }
      });
    });
  </script>
</body>
</html>